<!-- src/components/PasswordProtected.astro -->
---
interface Props {
	postId: string;
	hashedPassword: string; // 接收加密后的哈希值
}

const { postId, hashedPassword } = Astro.props;
let error = "";
---

<script>
  // 引入 bcryptjs 用于密码比对
  import bcrypt from 'bcryptjs';

  // 绑定到 DOM 加载完成后执行
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const inputPassword = e.target.password.value;
        const errorElement = document.querySelector('.error-message');
        
        // 比对输入密码与存储的哈希值
        const isMatch = await bcrypt.compare(inputPassword, '{hashedPassword}');
        
        if (isMatch) {
          // 验证通过，存储状态
          localStorage.setItem(`post_${postId}_verified`, 'true');
          localStorage.setItem(`post_${postId}_expires`, (Date.now() + 86400000).toString());
          window.location.reload();
        } else {
          errorElement.textContent = '密码错误，请重试';
        }
      });
    }
  });
</script>

<div class="max-w-md mx-auto p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
  <h2 class="text-2xl font-bold mb-4">该内容受密码保护</h2>
  <p class="error-message text-red-500 mb-4">{error}</p>
  <form class="space-y-4">
    <div>
      <label for="password" class="block mb-2">请输入密码</label>
      <input 
        type="password" 
        id="password" 
        name="password"
        required
        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700"
      >
    </div>
    <button 
      type="submit"
      class="w-full p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
    >
      解锁内容
    </button>
  </form>
</div>